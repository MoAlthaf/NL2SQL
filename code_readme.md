## nl2nl.py

### Function: get_tokenizer()
Description: Returns a singleton instance of the tokenizer required for the NL2NL model.

Inputs: None

Output:

tokenizer (AutoTokenizer): Hugging Face tokenizer for the paraphrasing model

Functions Used: None

Notes:

Caches the tokenizer globally to avoid re-initializing across calls

### Function: get_llm_nl2nl()
Description: Returns a singleton instance of the LLM used for paraphrasing.

Inputs: None

Output:

llm (LLM): An instantiated vllm.LLM model with parallelism support

Functions Used: None

Notes:

Uses global caching

Loads the model with tokenizer, trust settings, and tensor_parallel_size=2

Expects environment variable HF_TOKEN to be set

### Function: paraphrase_sentence(sentence: str, schema: str = "")
Description: Paraphrases a natural language question using an LLM while preserving SQL semantics. Falls back to original if any exception occurs.

Inputs:

sentence (str): Original natural language question

schema (str, optional): Pipe-separated table schema used for contextual paraphrasing

Output:

paraphrased_question (str): Rewritten version of the input question with identical meaning

Functions Used:

get_tokenizer()

get_llm_nl2nl()

Notes:

Applies strong constraints to avoid semantic drift

Embeds system instructions to guide the LLM

If LLM inference fails, returns the original sentence

------

## nl2sql.py

### Function: get_llm_nl2sql()
Description: Returns a singleton instance of the LLM used for SQL generation.

Inputs: None

Output:

llm (LLM): A vllm.LLM instance used for generating SQL queries

Functions Used: None

Notes:

Uses global caching

Initializes with tensor_parallel_size=2 for better performance

Expects HF_TOKEN in environment

### Function: get_tokenizer()
Description: Returns a singleton tokenizer instance for the SQL generation model.

Inputs: None

Output:

tokenizer (AutoTokenizer): Tokenizer matching the LLM for SQL generation

Functions Used: None

Notes:

Uses Hugging Face tokenizer with trust_remote_code=True

Caches globally to avoid redundant loads

### Function: generate_sql(db_name: str, question: str)
Description: Converts a natural language question into a SQL query using the LLM, guided by the schema of a specified database.

Inputs:

db_name (str): The name of the database (used to fetch schema)

question (str): The userâ€™s natural language query

Output:

sql_query (str): SQL query generated by the model

Functions Used:

get_llm_nl2sql()

get_tokenizer()

generate_simplified_schema()

Notes:

Uses a chat-based prompt with schema context and strict generation rules

Falls back to "" on failure

### Function: reverifier(initial_sql: str, db_id: str, gt_sql: str, question: str, max_retries: int = 5) -> tuple[str, bool, int]
Description: Attempts to repair a faulty SQL query by retrying up to max_retries times using the LLM. Returns whether the generated SQL matches the ground truth.

Inputs:

initial_sql (str): SQL generated in the first attempt

db_id (str): ID of the database for schema context

gt_sql (str): Ground truth SQL to match

question (str): The original user question

max_retries (int, optional): Number of attempts allowed (default: 5)

Output:

tuple: (final_sql: str, matched: bool, attempts: int)

attempts = -1 if fix failed

Functions Used:

run_all() (from sql_utils)

get_tokenizer()

get_llm_nl2sql()

generate_simplified_schema()

Notes:

Maintains a list of previous SQL versions

Uses schema-guided LLM correction

Handles semantic SQL issues like invalid joins, missing filters

## sql_utils.py

### Function: check_db_exists(db_path)
Description: Checks whether a SQLite database file exists at the given path.

Inputs:

db_path (str or Path): Full path to the .sqlite file

Output: None

Raises: FileNotFoundError if the file does not exist

Functions Used: None

### Function: connect_to_db(db_path)
Description: Establishes a connection to a SQLite database.

Inputs:

db_path (str or Path): Path to the SQLite file

Output:

conn (sqlite3.Connection): SQLite connection object

Raises: ConnectionError on failure

Functions Used: None

### Function: check_table_exists(conn, table_name)
Description: Verifies if a table exists in a given SQLite database.

Inputs:

conn (sqlite3.Connection): Active SQLite connection

table_name (str): Table name to check

Output: None

Raises: ValueError if the table does not exist

Functions Used: None

### Function: run_query(conn, query)
Description: Executes a SQL query and returns results as a DataFrame.

Inputs:

conn (sqlite3.Connection): Active database connection

query (str): SQL query string

Output:

df (pd.DataFrame): Query result as DataFrame

Raises: ValueError on query failure

Functions Used: None

### Function: compare_results(df1, df2)
Description: Compares two DataFrames for equality, ignoring row order, column order, and NaNs.

Inputs:

df1 (pd.DataFrame): First result set

df2 (pd.DataFrame): Second result set

Output:

is_equal (bool): True if results match, else False

Functions Used: None

Notes:

Internally handles NaNs and type inconsistencies

Converts rows to strings for order-independent comparison

### Function: run_all(dbname, query1, query2)
Description: Executes two SQL queries on the same database and compares their results.

Inputs:

dbname (str): Database name (used to construct path)

query1 (str): First SQL query

query2 (str): Second SQL query

Output:

matched (bool): True if query outputs match, False otherwise

Functions Used:

check_db_exists()

connect_to_db()

run_query()

compare_results()

Notes:

Automatically builds database path from data/database/

Prints error but returns False if exception occurs

### Function: generate_simplified_schema(db_name)
Description: Constructs a human-readable schema description string for a given SQLite database.

Inputs:

db_name (str): Name of the database

Output:

schema_str (str or None): Simplified schema description (or None on failure)

Functions Used: None

Notes:

Extracts all tables and columns using PRAGMA table_info

Marks primary keys

Returns multi-line string for use in prompts

